/* SPDX-License-Identifier: (GPL-2.0+ OR BSD-3-Clause) */
/*
 * Copyright (C) STMicroelectronics 2017 - All Rights Reserved
 * Author: Ludovic Barre <ludovic.barre@st.com> for STMicroelectronics.
 */

/dts-v1/;

#include "stm32mp157c.dtsi"
#include "stm32mp157-pinctrl.dtsi"
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>

/ {
	model = "STMicroelectronics STM32MP157C pmic eval daughter";
	compatible = "st,stm32mp157c-ed1", "st,stm32mp157";

	chosen {
		bootargs = "earlyprintk console=ttyS3,115200 root=/dev/ram";
		stdout-path = "serial3:115200n8";
	};

	memory {
		reg = <0xC0000000 0x40000000>;
	};

	reserved-memory {
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;

		ipc_share: sram_rproc@30040000 {
			compatible = "shared-dma-pool";
			reg = <0x30040000 0x10000>;
			no-map;
		};

		dma1_reserved: sram_dma1@30050000 {
			reg = <0x30050000 0x8000>;
			no-map;
		};

		dma2_reserved: sram_dma2@30058000 {
			reg = <0x30058000 0x8000>;
			no-map;
		};

		gcnano_reserved: gpu@f8000000 {
			reg = <0xf8000000 0x8000000>;
			no-map;
		};
	};

	gpio_keys {
		compatible = "gpio-keys";
		#address-cells = <1>;
		#size-cells = <0>;
		autorepeat;

		status = "disabled";
		button@0 {
			label = "User PA13";
			linux,code = <BTN_0>;
			interrupt-parent = <&gpioa>;
			interrupts = <13 1>;

			status = "disabled";
		};
		button@1 {
			label = "User PA14";
			linux,code = <BTN_1>;
			interrupt-parent = <&gpioa>;
			interrupts = <14 1>;

			status = "disabled";
		};
	};

	led {
		compatible = "gpio-leds";

		status = "disabled";
		red {
			label = "stm32mp:red:status";
			gpios = <&gpioa 13 GPIO_ACTIVE_LOW>;

			status = "disabled";
		};
		green {
			label = "stm32mp:green:user";
			gpios = <&gpioa 14 GPIO_ACTIVE_LOW>;

			status = "disabled";
		};
	};

	sd_switch: regulator-sd_switch {
		compatible = "regulator-gpio";
		regulator-name = "sd_switch";
		regulator-min-microvolt = <1800000>;
		regulator-max-microvolt = <2900000>;
		regulator-type = "voltage";
		regulator-always-on;

		gpios = <&gpiof 14 GPIO_ACTIVE_HIGH>;
		gpios-states = <0>;
		states = <1800000 0x1 2900000 0x0>;
	};
};

&adc {
	pinctrl-names = "default";
	/* ANA0, ANA1 are dedicated pins and don't need pinctrl: only in6. */
	pinctrl-0 = <&adc1_in6_pins_a>;
	vref-supply = <&vdda>;
	status = "okay";
	adc1: adc@0 {
		st,adc-channels = <0 1 6>;
		/* 16.5 ck_cycles sampling time */
		st,min-sample-time-nsecs = <400>;
		status = "okay";
	};
	jadc1: jadc@0 {
		st,adc-channels = <0 1 6>;
		/* 16.5 ck_cycles sampling time */
		st,min-sample-time-nsecs = <400>;
		status = "okay";
	};
};

&dac {
	pinctrl-names = "default";
	pinctrl-0 = <&dac_ch1_pins_a &dac_ch2_pins_a>;
	vref-supply = <&vdda>;
	status = "okay";
	dac1: dac@1 {
		status = "okay";
	};
	dac2: dac@2 {
		status = "okay";
	};
};

&dma1 {
	memory-region = <&dma1_reserved>;
};

&dma2 {
	memory-region = <&dma2_reserved>;
};

&gcnano {
	contiguous-area = <&gcnano_reserved>;
	status = "okay";
};

&i2c4 {
	pinctrl-names = "default";
	pinctrl-0 = <&i2c4_pins_a>;
	i2c-scl-rising-time-ns = <185>;
	i2c-scl-falling-time-ns = <20>;
	status = "okay";

	pmic: stpmu1@33 {
		compatible = "st,stpmu1";
		reg = <0x33>;
		interrupts = <0 2>;
		interrupt-parent = <&gpioa>;
		interrupt-controller;
		#interrupt-cells = <2>;
		status = "okay";

		st,main_control_register = <0x04>;
		st,vin_control_register = <0xc0>;
		st,usb_control_register = <0x30>;

		regulators {
			compatible = "st,stpmu1-regulators";

			ldo1-supply = <&v3v3>;
			ldo2-supply = <&v3v3>;
			ldo5-supply = <&v3v3>;
			ldo6-supply = <&v3v3>;
			vref_ddr-supply = <&vdd_ddr>;
			vbus_otg-supply = <&bst_out>;
			sw_out-supply = <&bst_out>;

			vddcore: buck1 {
				regulator-compatible = "buck1";
				regulator-name = "vddcore";
				regulator-min-microvolt = <800000>;
				regulator-max-microvolt = <1350000>;
				regulator-always-on;
				regulator-initial-mode = <2>;
				regulator-over-current-protection;

				regulator-state-standby {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <900000>;
					regulator-mode = <8>;
				};
				regulator-state-mem {
					regulator-off-in-suspend;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			vdd_ddr: buck2 {
				regulator-compatible = "buck2";
				regulator-name = "vdd_ddr";
				regulator-min-microvolt = <1350000>;
				regulator-max-microvolt = <1350000>;
				regulator-always-on;
				regulator-initial-mode = <2>;
				regulator-over-current-protection;

				regulator-state-standby {
					regulator-suspend-microvolt = <1350000>;
					regulator-on-in-suspend;
					regulator-mode = <8>;
				};
				regulator-state-mem {
					regulator-suspend-microvolt = <1350000>;
					regulator-on-in-suspend;
					regulator-mode = <8>;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			vdd: buck3 {
				regulator-compatible = "buck3";
				regulator-name = "vdd";
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-always-on;
				st,mask_reset;
				regulator-initial-mode = <2>;
				regulator-over-current-protection;

				regulator-state-standby {
					regulator-suspend-microvolt = <3300000>;
					regulator-on-in-suspend;
					regulator-mode = <8>;
				};
				regulator-state-mem {
					regulator-suspend-microvolt = <3300000>;
					regulator-on-in-suspend;
					regulator-mode = <8>;
				};
				regulator-state-disk {
					regulator-suspend-microvolt = <3300000>;
					regulator-on-in-suspend;
					regulator-mode = <8>;
				};
			};

			v3v3: buck4 {
				regulator-compatible = "buck4";
				regulator-name = "v3v3";
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-always-on;
				regulator-over-current-protection;

				regulator-state-standby {
					regulator-suspend-microvolt = <3300000>;
					regulator-on-in-suspend;
				};
				regulator-state-mem {
					regulator-off-in-suspend;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			vdda: ldo1 {
				regulator-compatible = "ldo1";
				regulator-name = "vdda";
				regulator-min-microvolt = <2900000>;
				regulator-max-microvolt = <2900000>;

				regulator-state-standby {
					regulator-suspend-microvolt = <2900000>;
					regulator-unchanged-in-suspend;
				};
				regulator-state-mem {
					regulator-off-in-suspend;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			v2v8: ldo2 {
				regulator-compatible = "ldo2";
				regulator-name = "v2v8";
				regulator-min-microvolt = <2800000>;
				regulator-max-microvolt = <2800000>;

				regulator-state-standby {
					regulator-off-in-suspend;
				};
				regulator-state-mem {
					regulator-off-in-suspend;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			vtt_ddr: ldo3 {
				regulator-compatible = "ldo3";
				regulator-name = "vtt_ddr";
				regulator-min-microvolt = <0000000>;
				regulator-max-microvolt = <1000000>;
				regulator-always-on;
				regulator-over-current-protection;

				regulator-state-standby {
					regulator-off-in-suspend;
				};
				regulator-state-mem {
					regulator-off-in-suspend;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			vdd_usb: ldo4 {
				regulator-compatible = "ldo4";
				regulator-name = "vdd_usb";
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;

				regulator-state-standby {
					regulator-unchanged-in-suspend;
				};
				regulator-state-mem {
					regulator-off-in-suspend;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			vdd_sd: ldo5 {
				regulator-compatible = "ldo5";
				regulator-name = "vdd_sd";
				regulator-min-microvolt = <2900000>;
				regulator-max-microvolt = <2900000>;

				regulator-state-standby {
					regulator-suspend-microvolt = <2900000>;
					regulator-unchanged-in-suspend;
				};
				regulator-state-mem {
					regulator-off-in-suspend;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			v1v8: ldo6 {
				regulator-compatible = "ldo6";
				regulator-name = "v1v8";
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;

				regulator-state-standby {
					regulator-off-in-suspend;
				};
				regulator-state-mem {
					regulator-off-in-suspend;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			vref_ddr: vref1 {
				regulator-compatible = "vref_ddr";
				regulator-name = "vref_ddr";
				regulator-always-on;
				regulator-over-current-protection;

				regulator-state-standby {
					regulator-on-in-suspend;
				};
				regulator-state-mem {
					regulator-on-in-suspend;
				};
				regulator-state-disk {
					regulator-off-in-suspend;
				};
			};

			 bst_out: bst_out1 {
				regulator-compatible = "boost";
				regulator-name = "bst_out";
				regulator-over-current-protection;
			 };

			vbus_otg: pwr_sw1 {
				regulator-compatible = "vbus_otg";
				regulator-name = "vbus_otg";
				regulator-active-discharge;
			 };

			 vbus_sw: pwr_sw2 {
				regulator-compatible = "sw_out";
				regulator-name = "vbus_sw";
				regulator-active-discharge;
			 };
		};

		protection_v1v8 {
			compatible = "protection-consumer";
			protection-supply = <&v1v8>;
			status = "okay";
			interrupts = <18 0>;
			interrupt-parent = <&pmic>;
		};

		protection_v2v8 {
			compatible = "protection-consumer";
			protection-supply = <&v2v8>;
			status = "okay";
			interrupts = <22 0>;
			interrupt-parent = <&pmic>;
		};

		protection_vdd_usb {
			compatible = "protection-consumer";
			protection-supply = <&vdd_usb>;
			status = "okay";
			interrupts = <20 0>;
			interrupt-parent = <&pmic>;
		};

		protection_vdd_sd {
			compatible = "protection-consumer";
			protection-supply = <&vdd_sd>;
			status = "okay";
			interrupts = <19 0>;
			interrupt-parent = <&pmic>;
		};

		protection_vdda {
			compatible = "protection-consumer";
			protection-supply = <&vdda>;
			status = "okay";
			interrupts = <23 0>;
			interrupt-parent = <&pmic>;
		};

		protection_vbus_otg {
			compatible = "protection-consumer";
			protection-supply = <&vbus_otg>;
			status = "okay";
			interrupts = <17 0>;
			interrupt-parent = <&pmic>;
		};

		protection_vbus_sw {
			compatible = "protection-consumer";
			protection-supply = <&vbus_sw>;
			status = "okay";
			interrupts = <16 0>;
			interrupt-parent = <&pmic>;
		};

		onkey {
			compatible = "st,stpmu1-onkey";
			interrupt-parent = <&pmic>;
			interrupts = <7 0>,<6 1>;
			interrupt-names = "onkey-falling", "onkey-rising";
			status = "okay";
		};

		watchdog {
			compatible = "st,stpmu1-wdt";
		};
	};
};

&ipcc {
	status = "okay";
};

&iwdg {
	timeout-sec = <32>;
	status = "okay";
};

&m4_rproc {
	memory-region = <&ipc_share>;
	mboxes = <&ipcc 0 0>, <&ipcc 0 1>;
	interrupt-parent = <&exti>;
	interrupts = <68 1>;
	interrupt-names = "wdg";
	status = "okay";
};

&pwr {
	pwr-supply = <&vdd>;
};

&sdmmc1 {
	pinctrl-names = "default";
	pinctrl-0 = <&sdmmc1_b4_pins_a &sdmmc1_dir_pins_a>;
	broken-cd;
	st,dirpol;
	st,negedge;
	bus-width = <4>;
	vmmc-supply = <&vdd_sd>;
	vqmmc-supply = <&sd_switch>;
	status = "okay";
};

&sdmmc2 {
	pinctrl-names = "default";
	pinctrl-0 = <&sdmmc2_b4_pins_a &sdmmc2_d47_pins_a>;
	non-removable;
	no-sd;
	no-sdio;
	st,dirpol;
	st,negedge;
	bus-width = <8>;
	vmmc-supply = <&v3v3>;
	vqmmc-supply = <&vdd>;
	status = "okay";
};

&timers6 {
	status = "okay";
	timer@5 {
		status = "okay";
	};
};

&uart4 {
	pinctrl-names = "default";
	pinctrl-0 = <&uart4_pins_a>;
	status = "okay";
};

&usbo {
	vbus-supply = <&vbus_otg>;
};

&usbphyc {
	vdd-supply = <&vdd_usb>;
};
